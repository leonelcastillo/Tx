<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel público - Registro de botellas</title>
  <style>
    :root{--card-bg:rgba(255,255,255,0.9);--overlay:rgba(0,0,0,0.35)}
    html,body{height:100%}
    body{
      font-family:Segoe UI,Arial;
      margin:0;padding:0;
      min-height:100%;
      background-image:url('/static/ecyv.svg');
      background-size:cover;
      background-position:center center;
      background-repeat:no-repeat;
      padding:24px;display:flex;flex-direction:column;align-items:center;
    }
    .bg-overlay{position:fixed;inset:0;background:var(--overlay);pointer-events:none}
    .container{position:relative;z-index:2;width:100%;max-width:900px}
    .card{background:var(--card-bg);padding:12px;border-radius:10px;margin-bottom:8px;box-shadow:0 6px 18px rgba(15,23,42,0.08)}
    h1,h2{color:#fff}
    #debug{color:#ffdddd;margin-top:12px;font-weight:bold}
    @media(max-width:640px){body{padding:12px}.container{padding:0 8px}}
    /* Mobile nav link tweaks: show as plain text (no underlines) */
    nav#mobile-nav ul{padding-left:0}
    nav#mobile-nav a{color:inherit;text-decoration:none;display:block;padding:6px 0;font-weight:600;border-bottom:none}
    nav#mobile-nav a:hover, nav#mobile-nav a:focus{opacity:0.9;text-decoration:none}
  </style>
</head>
<body>
  <div class="bg-overlay" aria-hidden="true"></div>
  <div class="container">
  <h1>Panel público</h1>
  <!-- Mobile header / burger menu (compact) -->
  <header style="position:relative;z-index:3;max-width:900px;margin:8px 0;padding:0 8px;display:flex;align-items:center;justify-content:space-between">
    <button id="burger" aria-label="Abrir menú" aria-expanded="false" style="font-size:20px;padding:8px 10px;border-radius:8px;border:0;background:rgba(255,255,255,0.6);color:#fff;backdrop-filter:blur(4px)">☰</button>
    <div style="color:#fff;font-weight:700">Observar</div>
    <nav id="mobile-nav" aria-hidden="true" style="position:fixed;top:0;right:-320px;width:280px;height:100%;background:rgba(255,255,255,0.97);box-shadow:-6px 0 18px rgba(2,6,23,0.35);transition:right .25s;z-index:40;padding:18px">
      <button id="close-nav" aria-label="Cerrar" style="float:right;border:0;background:transparent;font-size:18px">✕</button>
      <ul style="list-style:none;padding:16px 0;margin:36px 0 0 0;display:flex;flex-direction:column;gap:12px">
        <li><a href="https://pambiclub.vercel.app/">Inicio</a></li>
        <li><a href="/static/submit_es.html">Reciclar</a></li>
        <li><a href="/static/observer_es.html">Observar</a></li>
        <li><a href="/static/ranking_es.html" >Ranking</a></li>
        <li><a href="https://wa.me/584122550770" target="_blank" rel="noopener noreferrer">Contacto</a></li>
      </ul>
    </nav>
    <div id="nav-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:30"></div>
  </header>
  <div id="stats"></div>

  <!-- Filter controls: All / Collected / Pending -->
  <div style="margin-top:12px;max-width:720px;">
    <div class="card" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:700;color:#1a202c">Filtrar:</div>
      <div id="filter-controls" style="display:flex;gap:8px">
        <button class="filter-btn" data-filter="all" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:#111">Todos</button>
        <button class="filter-btn" data-filter="collected" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:#111">Recogidas</button>
        <button class="filter-btn" data-filter="pending" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:#111">Pendientes</button>
      </div>
      <div style="margin-left:auto;color:#1a202c;font-size:13px" id="list-info"></div>
      <!-- Search box: search by name or wallet -->
      <div style="width:100%;margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="search-input" type="search" placeholder="Buscar por nombre o wallet..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
        <button id="clear-search" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent">Limpiar</button>
      </div>
    </div>
  </div>
  <div class="card" style="padding:8px;margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div id="pagination" style="flex:1;display:flex;align-items:center;gap:12px"></div>
  </div>

  <h2 style="margin-top:14px">Últimas transacciones</h2>
  <div id="list"></div>
  <div id="debug" style="color:#c00;margin-top:12px;font-weight:bold"></div>

  <!-- Authentication removed for MVP - leaderboard is public and aggregates by wallet field -->

  <!-- Leaderboard removed for this view; ranking is on a dedicated page -->

  <script>
    async function loadLeaderboard(){
      try {
        const r = await fetch('/ranking')
        const data = await r.json()
        renderLeaderboard(data)
      } catch (e) {
        console.error('Failed loading ranking', e)
        document.getElementById('leaderboard').innerText = 'Error cargando ranking'
      }
    }

    function renderLeaderboard(rows) {
      const container = document.getElementById('leaderboard')
      if(!rows || rows.length === 0){ container.innerHTML = '<p>No hay datos aún.</p>'; return }
      let html = '<ol>'
      for(const row of rows){
        const wallet = row.wallet || 'anonymous'
        html += `<li style="margin:6px 0;"><strong>${escapeHtml(wallet)}</strong> — ${(+row.total_kg).toFixed(2)} kg</li>`
      }
      html += '</ol>'
      container.innerHTML = html
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

    // load on start
    loadLeaderboard()

    // visible debug output so we don't depend on console
    const dbg = document.getElementById('debug')
    //dbg.innerText = 'script loaded'

    window.addEventListener('error', (ev) => {
      console.error(ev.error || ev.message)
      dbg.innerText = 'Global error: ' + (ev.error?.message || ev.message)
    })

  // transaction list / filter behavior
  let allTransactions = []
  let currentFilter = 'all' // all | collected | pending
  let currentPage = 1
  let pageSize = 10
  let searchQuery = ''

    function applyFilterAndRender(){
      const el = document.getElementById('list')
      el.innerHTML = ''
      // exclude cancelled transactions
      let items = allTransactions.filter(t => (t.status || '').toLowerCase() !== 'cancelled' && (t.status || '').toLowerCase() !== 'cancelada')
      // sort by collected_at desc, then date desc, then created_at desc (most recent first).
      // Some rows record the actual timestamp in `collected_at` so prefer that when present.
      // use Date.parse for robust parsing and prefer rows with a collected_at timestamp
      function tsOf(r){
        const v = (r && (r.collected_at || r.date || r.created_at)) || ''
        const p = Date.parse(v)
        return isNaN(p) ? 0 : p
      }
      function hasCollected(r){ return !!(r && r.collected_at) }
      items.sort((a,b)=>{
        // first prefer items that have collected_at (so recently-collected show above submitted-only)
        const ha = hasCollected(a) ? 1 : 0
        const hb = hasCollected(b) ? 1 : 0
        if(hb !== ha) return hb - ha
        // then sort by timestamp (newest first)
        return tsOf(b) - tsOf(a)
      })
      // apply filter
      if(currentFilter === 'collected') items = items.filter(t => (t.status || '').toLowerCase() === 'collected' || (t.status || '').toLowerCase() === 'recogida' || (t.status || '').toLowerCase() === 'recibida')
      if(currentFilter === 'pending') items = items.filter(t => (t.status || '').toLowerCase() === 'pending' || (t.status || '').toLowerCase() === 'pendiente')

      // apply search query (case-insensitive) on name and wallet
      if(searchQuery){
        const q = searchQuery.toLowerCase()
        items = items.filter(t => {
          const name = (t.name || '').toLowerCase()
          const wallet = (t.wallet || '').toLowerCase()
          return name.includes(q) || wallet.includes(q)
        })
      }

      // pagination
      const totalItems = items.length
      const totalPages = Math.max(1, Math.ceil(totalItems / pageSize))
      if(currentPage > totalPages) currentPage = totalPages
      const start = (currentPage - 1) * pageSize
      const end = start + pageSize
      const pageItems = items.slice(start, end)

      document.getElementById('list-info').innerText = `Mostrando ${pageItems.length} de ${items.length} coincidencias (página ${currentPage}/${totalPages})`
      if(items.length === 0){ el.innerText = 'Sin transacciones que mostrar'; renderPaginationControls(items.length); return }
      pageItems.forEach(t => {
        const d = document.createElement('div')
        d.className = 'card'
          let imgHtml = ''
          // Show submission and collected photos side-by-side; keep label words but omit the URL text
          if(t.photo || t.collected_photo){
            imgHtml += '<div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:8px">'
            if(t.photo){
              const url = '/static/uploads/' + t.photo
              imgHtml += `<div style="display:flex;flex-direction:column;align-items:flex-start"><div style="font-size:12px;color:#666;margin-bottom:4px">Original:</div><a href="${url}" target="_blank" style="display:block"><img src="${url}" style="max-width:120px;max-height:80px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'" alt="Imagen envío"/></a></div>`
            }
            if(t.collected_photo){
              const curl = '/static/uploads/' + t.collected_photo
              imgHtml += `<div style="display:flex;flex-direction:column;align-items:flex-start"><div style="font-size:12px;color:#666;margin-bottom:4px">Foto recogida:</div><a href="${curl}" target="_blank" style="display:block"><img src="${curl}" style="max-width:120px;max-height:80px;object-fit:cover;border-radius:6px;border:2px solid #2b6cb0" onerror="this.style.display='none'" alt="Imagen recogida"/></a></div>`
            }
            imgHtml += '</div>'
          }

        // decide which weight to show: prefer collected_weight if present
        const displayWeight = (t.collected_weight_kg != null) ? `${t.collected_weight_kg} kg (recogido)` : ((t.weight_kg != null) ? `${t.weight_kg} kg` : '—')
        // prefer collected_at timestamp when present
        const when = t.collected_at || t.date || t.created_at || ''
        d.innerHTML = `${imgHtml}<b>${t.name}</b> - ${displayWeight} - ${t.status} <br/> ${when}`
        el.appendChild(d)
      })

      renderPaginationControls(items.length)
    }

    // render pagination controls (Prev/Next, page numbers, page-size selector)
    function renderPaginationControls(totalItems){
      const paginationEl = document.getElementById('pagination')
      if(!paginationEl) return
      const totalPages = Math.max(1, Math.ceil(totalItems / pageSize))
      // build basic controls
      let html = ''
      html += '<div style="display:flex;gap:6px;align-items:center">'
      html += '<button id="prev-page" ' + (currentPage===1 ? 'disabled' : '') + ' style="padding:6px 8px;border-radius:6px">Anterior</button>'
      html += '<div id="page-buttons" style="display:flex;gap:6px;margin:0 8px"></div>'
      html += '<button id="next-page" ' + (currentPage===totalPages ? 'disabled' : '') + ' style="padding:6px 8px;border-radius:6px">Siguiente</button>'
      html += '</div>'
      html += '<div style="margin-left:12px">Mostrar: <select id="page-size-select"><option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="100">100</option></select></div>'
      paginationEl.innerHTML = html

      // populate page number buttons (show a small window around current page)
      const pageButtonsContainer = document.getElementById('page-buttons')
      const windowSize = 5
      let startPage = Math.max(1, currentPage - Math.floor(windowSize/2))
      let endPage = Math.min(totalPages, startPage + windowSize - 1)
      if(endPage - startPage + 1 < windowSize){ startPage = Math.max(1, endPage - windowSize + 1) }
      for(let p = startPage; p <= endPage; p++){
        const btn = document.createElement('button')
        btn.textContent = p
        btn.dataset.page = p
        btn.style.padding = '6px 8px'
        btn.style.borderRadius = '6px'
        btn.style.border = '1px solid rgba(0,0,0,0.06)'
        btn.style.background = p === currentPage ? 'rgba(0,0,0,0.12)' : 'transparent'
        btn.style.color = p === currentPage ? '#fff' : '#111'
        pageButtonsContainer.appendChild(btn)
      }

      // wire small controls
      const prev = document.getElementById('prev-page')
      const next = document.getElementById('next-page')
      const sizeSelect = document.getElementById('page-size-select')
      prev && (prev.onclick = ()=>{ if(currentPage>1){ currentPage--; applyFilterAndRender() } })
      next && (next.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; applyFilterAndRender() } })
      sizeSelect && (sizeSelect.value = String(pageSize))
      sizeSelect && (sizeSelect.onchange = (e)=>{ pageSize = Number(e.target.value || 10); currentPage = 1; applyFilterAndRender() })
      pageButtonsContainer && pageButtonsContainer.addEventListener('click', (ev)=>{
        const b = ev.target.closest && ev.target.closest('button')
        if(!b || !b.dataset.page) return
        const p = Number(b.dataset.page)
        if(!isNaN(p)) { currentPage = p; applyFilterAndRender() }
      })
    }

    // wire filter buttons
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest && ev.target.closest('.filter-btn')
      if(!btn) return
      const f = btn.getAttribute('data-filter')
      if(!f) return
      currentFilter = f
      // reset to first page when filter changes
      currentPage = 1
  // visual active state: dark translucent background with white text for contrast
  document.querySelectorAll('.filter-btn').forEach(b=>{ b.style.background = 'transparent'; b.style.color = '#111' })
  btn.style.background = 'rgba(0,0,0,0.18)'; btn.style.color = '#fff'
      applyFilterAndRender()
    })

    // search input wiring
    const searchInput = document.getElementById('search-input')
    const clearSearch = document.getElementById('clear-search')
    if(searchInput){
      searchInput.addEventListener('input', (e)=>{
        searchQuery = String(e.target.value || '').trim()
        currentPage = 1
        applyFilterAndRender()
      })
    }
    if(clearSearch){
      clearSearch.addEventListener('click', ()=>{
        if(searchInput) searchInput.value = ''
        searchQuery = ''
        currentPage = 1
        applyFilterAndRender()
      })
    }

    async function load(){
      try{
        const s = await fetch('/stats')
        if(!s.ok) throw new Error('stats fetch failed: ' + s.status)
  const stats = await s.json()
  const totalKg = (stats && stats.total_kg != null) ? Number(stats.total_kg).toFixed(2) : '0.00'
  document.getElementById('stats').innerHTML = `<div class="card">Total kg: ${totalKg} | Transacciones: ${stats.total_count}</div>`

        // fetch more items (server side limit still applies) to ensure we can sort/filter reliably
        const l = await fetch('/transactions?limit=100')
        if(!l.ok) throw new Error('transactions fetch failed: ' + l.status)
        const items = await l.json()
        // store
        allTransactions = Array.isArray(items) ? items : []
        // default visual active
        const firstBtn = document.querySelector('.filter-btn[data-filter="all"]')
        if(firstBtn) firstBtn.style.background = 'rgba(255,255,255,0.12)'
        applyFilterAndRender()
      }catch(e){
        console.error(e)
        dbg.innerText = 'JS error: ' + (e.message || e)
      }
    }
    load()
  </script>
  <script>
    // burger menu logic
    (function(){
      const burger = document.getElementById('burger')
      const nav = document.getElementById('mobile-nav')
      const close = document.getElementById('close-nav')
      const overlay = document.getElementById('nav-overlay')
      function openNav(){ nav.style.right='0'; overlay.style.pointerEvents='auto'; overlay.style.opacity='1'; burger.setAttribute('aria-expanded','true'); nav.setAttribute('aria-hidden','false') }
      function closeNav(){ nav.style.right='-320px'; overlay.style.pointerEvents='none'; overlay.style.opacity='0'; burger.setAttribute('aria-expanded','false'); nav.setAttribute('aria-hidden','true') }
      burger && burger.addEventListener('click', openNav)
      close && close.addEventListener('click', closeNav)
      overlay && overlay.addEventListener('click', closeNav)
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeNav() })
    })()
  </script>
  </div>
</body>
</html>